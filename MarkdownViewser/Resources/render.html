<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <link rel="stylesheet" href="github-markdown.css">
    <link rel="stylesheet" href="katex.min.css">
    <link rel="stylesheet" href="prism.min.css" id="prism-light">
    <link rel="stylesheet" href="prism-tomorrow.min.css" id="prism-dark" disabled>
    <style>
        body {
            margin: 0;
            padding: 16px 32px;
            background: transparent;
        }
        .markdown-body {
            max-width: 980px;
            margin: 0 auto;
            font-size: 16px;
        }
        /* KaTeX dark mode */
        @media (prefers-color-scheme: dark) {
            .katex { color: #c9d1d9; }
        }
        /* Mermaid container */
        .mermaid-container {
            text-align: center;
            margin: 16px 0;
        }
        .mermaid-error {
            color: #d73a49;
            background: #ffeef0;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
        }
        @media (prefers-color-scheme: dark) {
            .mermaid-error {
                color: #f85149;
                background: #3d1f28;
            }
        }
    </style>
</head>
<body>
    <article class="markdown-body" id="content"></article>

    <script src="markdown-it.min.js"></script>
    <script src="markdown-it-task-lists.min.js"></script>
    <script src="katex.min.js"></script>
    <script src="katex-auto-render.min.js"></script>
    <script src="prism.min.js"></script>
    <!-- Prism language components -->
    <script src="prism-markup.min.js"></script>
    <script src="prism-css.min.js"></script>
    <script src="prism-clike.min.js"></script>
    <script src="prism-javascript.min.js"></script>
    <script src="prism-bash.min.js"></script>
    <script src="prism-c.min.js"></script>
    <script src="prism-cpp.min.js"></script>
    <script src="prism-go.min.js"></script>
    <script src="prism-java.min.js"></script>
    <script src="prism-json.min.js"></script>
    <script src="prism-kotlin.min.js"></script>
    <script src="prism-markdown.min.js"></script>
    <script src="prism-python.min.js"></script>
    <script src="prism-rust.min.js"></script>
    <script src="prism-sql.min.js"></script>
    <script src="prism-swift.min.js"></script>
    <script src="prism-typescript.min.js"></script>
    <script src="prism-yaml.min.js"></script>

    <script>
        // Initialize markdown-it
        const md = window.markdownit({
            html: true,
            linkify: true,
            typographer: true,
            highlight: function(str, lang) {
                if (lang === 'mermaid') {
                    return ''; // handled separately
                }
                const langClass = lang ? `language-${lang}` : '';
                const escaped = str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                return `<pre class="language-${lang || 'none'}"><code class="${langClass}">${escaped}</code></pre>`;
            }
        });

        // Enable task list plugin
        if (typeof markdownitTaskLists !== 'undefined') {
            md.use(markdownitTaskLists);
        }

        // Add IDs to headings for TOC navigation (with duplicate handling)
        const usedIds = {};
        md.renderer.rules.heading_open = function(tokens, idx) {
            const token = tokens[idx];
            const level = token.tag;
            const nextToken = tokens[idx + 1];
            const text = nextToken ? nextToken.content : '';
            let id = text.toLowerCase().replace(/\s+/g, '-').replace(/[^\p{L}\p{N}_-]/gu, '');
            if (usedIds[id]) {
                usedIds[id]++;
                id = id + '-' + usedIds[id];
            } else {
                usedIds[id] = 1;
            }
            return `<${level} id="${id}">`;
        };

        // Custom fence renderer for mermaid blocks
        const defaultFence = md.renderer.rules.fence.bind(md.renderer.rules);
        md.renderer.rules.fence = function(tokens, idx, options, env, self) {
            const token = tokens[idx];
            if (token.info.trim() === 'mermaid') {
                const code = token.content.trim();
                return `<div class="mermaid-container"><pre class="mermaid">${code}</pre></div>`;
            }
            if (token.info.trim() === 'math') {
                try {
                    return `<div class="math-block">${katex.renderToString(token.content.trim(), { displayMode: true, throwOnError: false })}</div>`;
                } catch(e) {
                    return `<div class="mermaid-error">${e.message}</div>`;
                }
            }
            return defaultFence(tokens, idx, options, env, self);
        };

        // Store reference to katex auto-render BEFORE defining render()
        const katexRenderMathInElement = (typeof renderMathInElement === 'function') ? renderMathInElement : null;

        // Set initial Prism theme based on color scheme
        const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.getElementById('prism-light').disabled = isDarkMode;
        document.getElementById('prism-dark').disabled = !isDarkMode;

        // Render function
        function render(markdownText) {
            const container = document.getElementById('content');
            container.innerHTML = md.render(markdownText);

            // Apply Prism.js highlighting
            Prism.highlightAllUnder(container);

            // Apply KaTeX auto-render
            if (katexRenderMathInElement) {
                katexRenderMathInElement(container, {
                    delimiters: [
                        {left: '$$', right: '$$', display: true},
                        {left: '$', right: '$', display: false},
                        {left: '\\(', right: '\\)', display: false},
                        {left: '\\[', right: '\\]', display: true}
                    ],
                    throwOnError: false,
                    strict: false
                });
            }

            // Lazy load Mermaid if needed
            const mermaidBlocks = container.querySelectorAll('.mermaid');
            if (mermaidBlocks.length > 0) {
                loadMermaid(mermaidBlocks);
            }

            // Scroll restore
            {{SCROLL_RESTORE}}
        }

        // Lazy load Mermaid
        async function loadMermaid(blocks) {
            if (!window.mermaidLoaded) {
                const script = document.createElement('script');
                script.src = 'mermaid.min.js';
                script.onload = function() {
                    const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                    mermaid.initialize({
                        startOnLoad: false,
                        theme: isDark ? 'dark' : 'default',
                        securityLevel: 'loose'
                    });
                    window.mermaidLoaded = true;
                    renderMermaidBlocks(blocks);
                };
                document.head.appendChild(script);
            } else {
                renderMermaidBlocks(blocks);
            }
        }

        async function renderMermaidBlocks(blocks) {
            for (const block of blocks) {
                try {
                    const code = block.textContent;
                    const id = 'mermaid-' + Math.random().toString(36).substr(2, 9);
                    const { svg } = await mermaid.render(id, code);
                    block.innerHTML = svg;
                } catch(e) {
                    block.innerHTML = `<div class="mermaid-error">Mermaid Error: ${e.message}</div>`;
                }
            }
        }

        // Listen for dark mode changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
            // Toggle Prism themes
            document.getElementById('prism-light').disabled = e.matches;
            document.getElementById('prism-dark').disabled = !e.matches;

            // Re-initialize Mermaid theme
            if (window.mermaidLoaded) {
                mermaid.initialize({
                    startOnLoad: false,
                    theme: e.matches ? 'dark' : 'default',
                    securityLevel: 'loose'
                });
            }
        });

        // Render the markdown content
        const markdownContent = `{{MARKDOWN_CONTENT}}`;
        render(markdownContent);
    </script>
</body>
</html>
